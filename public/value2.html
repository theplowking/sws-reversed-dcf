<!DOCTYPE html>
<head>
  <meta charset="utf-8">
<title>Mr Reverse DCF</title>
<style>

body {
  font: 16px sans-serif;
  /*background: #304459;
    color: white;*/
}

</style>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <link rel="stylesheet" href="/css/slider.css">
    <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
    <link rel="stylesheet" href="/css/chartist-plugin-tooltip.css">
    <script src="js/chartist-plugin-tooltip.js"></script>
    <script src="js/chartist-bar-labels.js"></script>
    <script src="js/dcf.js"></script>
    <script src="js/scenarios.js"></script>
  </head>

<body onload="runMe()">
 
 <h2>Mr Valuator!!!</h2>
  <input type="text" id="stocks" value="NasdaqGS:FB" placeholder="Simply Wall St ticker e.g. NasdaqGS:FB" style="width:250px;"/>
  <button type="submit" type="button" onclick="download()">Show me the money!</button>
<br><br>
<div style="width: 250px; display:inline-block; border: solid 1px #eee;vertical-align: top;">
  <h5>Next 3 years growth rate</h5>
      <div class="slider-container">

        <div class="slider-labels">
          <div class='label'>-50%</div>
          <div class='label'>0%</div>
          <div class='label'>50%</div>
          <div class='label'>100%</div>
          <div class='label'>150%</div>
          <div class='label'>200%</div>
        </div> 
        <input id="growthSlider" type="range" min="-50" max="200" step="1" value="0" class="slider">  
    </div>

    Growth rate: <input type="text" id="growthInput">%<br><br>
    <div id="growthArea"></div>
</div>

<div style="width: 250px; display:inline-block; border: solid 1px #eee;vertical-align: top;">
  <h5>Risk (discount rate)</h5>
      <div class="slider-container">

        <div class="slider-labels">
          <div class='label'>Low</div>
          <div class='label'>Medium</div>
          <div class='label'>High</div>
          <div class='label'>Very High</div>
        </div> 
        <input id="riskSlider" type="range" min="8" max="14" step="0.1" value="10" class="slider">  
    </div>

    Discount rate: <input type="text" id="riskInput">%
</div>

<div style="width: 250px; display:inline-block; border: solid 1px #eee;vertical-align: top;">
  <h5>Free Cash Flow Today</h5>

    Free Cash Flow: <input type="text" id="fcfInput" value="1000">M
</div>

<div style="width: 250px; display:inline-block; border: solid 1px #eee;vertical-align: top;">
  <h5>Long term growth rate (perpetual growth)</h5>

    Perpetual growth: <input type="text" id="riskFreeInput" value="1.9">%
</div>

  <br>
  <div id="resultsArea"></div>
 
  <h3>Scenarios</h3>
  <div id="barChart" class="ct-chart ct-minor-seventh" style="height:250px;"></div>
  <h3>Next 10 years Cash Flows</h3>
  <div id="lineChart" class="ct-chart ct-minor-seventh" style="height:250px;"></div>

  
</body>
<script>
var lowGrowth = 2;
var highGrowth = 15;
var lowCase = '2% per year';
var highCase = '15% per year';
var riskOriginal = 0.01;
var mktCaptoSP = 1;

var growthSlide = document.getElementById('growthSlider'),
    growthInput = document.getElementById("growthInput"),
    riskSlide = document.getElementById('riskSlider'),
    riskInput = document.getElementById("riskInput"),
    fcfInput = document.getElementById("fcfInput"),
    riskFreeInput = document.getElementById("riskFreeInput");


function runMe()
{

}

function download()
{
//NasdaqGS:GOOG,NasdaqGS:AMZN,NasdaqGS:FB,NasdaqGS:MTCH,NasdaqGS:MSFT,NasdaqGS:NFLX,NasdaqGS:NVDA,TSX:XID
retreive();

}


const retreive = async () => {
  let stock = document.getElementById('stocks').value;
  document.getElementById('resultsArea').innerHTML = "Fetching "+stock+" for you...";

  try {
    const response = await fetch("/reverse_dcf?stock="+stock);

    if(response.status!==200)
       {
          throw new Error(response.status)
       }

    const results = await response.json(); //extract JSON from the http response
    console.log(results);

     // if (results.assumptions.fcf < 0)
     // {
     //  //negative FCF
     //  fcfInput.value = results.revenue * 0.1;
     // }
    //load the values
    growthSlide.value = growthInput.value = results.result ? results.result.growth.toFixed(2) : 10;
    riskSlide.value = riskInput.value = (results.assumptions.discount * 100).toFixed(2);
    fcfInput.value = results.assumptions.fcf.toFixed(2);
    riskFreeInput.value = (results.assumptions.riskFree * 100).toFixed(2);

    riskOriginal = results.assumptions.discount;

    mktCaptoSP = results.share_price / results.goal;

    //selet cases
    if( results.future_growth && results.past_growth !== null )
    {
      if ( results.future_growth > results.past_growth )
      {
         highCase = 'Analysts Forecasts';
        var highGrowth = results.future_growth;
        var lowCase = 'Past Earnings';
        lowGrowth = results.past_growth;
      }
      else
      {
         lowCase = 'Analysts Forecasts';
        var lowGrowth = results.future_growth;
        var highCase = 'Past Earnings';
        highGrowth = results.past_growth;
      }
    }
    else
    {
      
        if ( results.assumptions.riskFree > results.past_growth )
        {
          highCase = 'Inflation Rate';
        var highGrowth = results.assumptions.riskFree;
        var lowCase = 'Past Earnings';
         lowGrowth = results.past_growth;
        }
        else
        {
         lowCase = 'Inflation Rate';
        var lowGrowth = results.assumptions.riskFree;
        var highCase = 'Past Earnings';
         highGrowth = results.past_growth;
        }
    }
    
  
    updateDCF(lowGrowth, highGrowth, lowCase, highCase, riskOriginal, mktCaptoSP);

    growthSlide.onchange = function() {
    growthInput.value = this.value;
    updateDCF(lowGrowth, highGrowth, lowCase, highCase, riskOriginal, mktCaptoSP);
}



riskSlide.onchange = function() {
    riskInput.value = this.value;
    updateDCF(lowGrowth, highGrowth, lowCase, highCase, riskOriginal, mktCaptoSP);
}

growthInput.onchange = function() { updateDCF(lowGrowth, highGrowth, lowCase, highCase, riskOriginal, mktCaptoSP); }
riskInput.onchange = function() { updateDCF(lowGrowth, highGrowth, lowCase, highCase, riskOriginal, mktCaptoSP); }
fcfInput.onchange = function() { updateDCF(lowGrowth, highGrowth, lowCase, highCase, riskOriginal, mktCaptoSP); }
riskFreeInput.onchange = function() { updateDCF(lowGrowth, highGrowth, lowCase, highCase, riskOriginal, mktCaptoSP); }
  
  let text = `<p>Low case: ${lowCase} cash flow growth @ ${lowGrowth.toFixed(2)}% per year
              <br>High case: ${highCase} cash flow growth @ ${highGrowth.toFixed(2)}% per year
              <br>Last share price: ${results.share_price}`;


    document.getElementById('resultsArea').innerHTML = text;

    
  } catch(err) {
    // catches errors both in fetch and response.json
    console.log(err);
    let text = "Either I can't find it, or its not free cash flow positive...";

    document.getElementById('resultsArea').innerHTML = text;

  }


  

  
}


</script>